# Cookie 过期预警功能演示

## 🎯 演示目标

本文档演示 Cookie 过期预警功能的完整使用流程，帮助你快速了解如何配置和使用这个功能。

## 📋 前置条件

- 已安装并配置理想汽车订单监控工具
- 已获取理想汽车 Cookie
- 已配置至少一种通知方式（微信或 ServerChan）

## 🚀 快速演示

### 步骤 1: 配置 Cookie 过期管理

编辑 `config.yaml`，添加以下配置：

```yaml
# Cookie 配置
lixiang_cookies: "your_cookie_string_here"

# Cookie 过期管理
cookie_valid_days: 7                     # Cookie 有效期 7 天
cookie_updated_at: "2025-10-20 10:00:00" # 设置为当前时间
```

**重要提示**: 
- `cookie_updated_at` 应该设置为你获取 Cookie 的时间
- `cookie_valid_days` 根据实际情况调整，建议初期设置为 7 天

### 步骤 2: 启动程序查看状态

```bash
./lixiang-monitor
```

启动后会看到 Cookie 状态信息：

```
2025/10/20 10:00:00 启动监控服务，检查间隔: @every 30m
2025/10/20 10:00:00 Cookie 状态: 🟢 正常 (剩余 7 天)
2025/10/20 10:00:00 监控服务已启动，等待定时检查...
```

### 步骤 3: Cookie 状态说明

程序会显示三种状态：

| 状态 | 图标 | 说明 | 操作 |
|------|------|------|------|
| 正常 | 🟢 | 距离过期还有 48 小时以上 | 无需操作 |
| 即将过期 | ⚠️ | 48 小时内将过期 | 尽快更新 Cookie |
| 已过期 | ❌ | Cookie 已失效 | 立即更新 Cookie |

## 🔔 预警通知演示

### 场景 1: Cookie 即将过期（48小时内）

当 Cookie 即将过期时，你会收到以下通知：

```
━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ Cookie 即将过期
━━━━━━━━━━━━━━━━━━━━━━━━

您的理想汽车 Cookie 即将在 1 天内过期

为避免影响订单监控，请尽快更新 Cookie。

🔄 更新步骤：
1. 访问理想汽车官网并登录
   https://www.lixiang.com/

2. 打开浏览器开发者工具 (F12)

3. 切换到 Network 标签页

4. 刷新页面或访问订单详情

5. 找到 order-web 相关的请求

6. 复制 Request Headers 中的 Cookie

7. 更新 config.yaml 中的两个字段：
   - lixiang_cookies: 新的 Cookie 值
   - cookie_updated_at: 当前时间

⏰ Cookie 有效期: 7 天
📅 更新时间: 2025-10-20 10:00:00
🕐 当前时间: 2025-10-27 09:00:00
⏳ 剩余时间: 1 天 1 小时

💡 提示: 更新后配置会自动重新加载，无需重启程序
```

### 场景 2: Cookie 已过期

如果错过了预警期，Cookie 已经过期，会收到：

```
━━━━━━━━━━━━━━━━━━━━━━━━
❌ Cookie 已过期
━━━━━━━━━━━━━━━━━━━━━━━━

您的理想汽车 Cookie 已经过期 1 天

请立即更新 Cookie 以恢复订单监控。

[后续内容同上...]
```

## 🔧 实际操作演示

### 演示 1: 模拟 Cookie 即将过期

想要测试预警功能，可以手动设置一个即将过期的时间：

```yaml
# 将 cookie_updated_at 设置为 5 天前
cookie_valid_days: 7
cookie_updated_at: "2025-10-15 10:00:00"  # 假设今天是 2025-10-20
```

启动程序后会看到：

```
Cookie 状态: ⚠️ 即将过期 (剩余 48 小时)
```

并且会收到预警通知。

### 演示 2: 更新 Cookie

收到预警后，按照以下步骤更新：

#### 2.1 获取新 Cookie

1. 访问 https://www.lixiang.com/ 并登录
2. 按 F12 打开开发者工具
3. 刷新页面
4. 在 Network 中找到请求
5. 复制 Cookie 值

![获取Cookie示例](../../assets/get-cookie-demo.png)

#### 2.2 更新配置文件

```yaml
# 更新 Cookie
lixiang_cookies: "新的Cookie字符串..."

# 更新时间为当前时间
cookie_updated_at: "2025-10-20 15:30:00"
```

#### 2.3 验证更新

保存配置文件后，查看程序日志：

```
2025/10/20 15:30:05 配置文件已重新加载: config.yaml
2025/10/20 15:30:05 Cookie 状态: 🟢 正常 (剩余 7 天)
```

✅ 配置已自动生效，无需重启！

## 🧪 使用测试脚本

我们提供了自动化测试脚本，可以快速验证功能：

```bash
# 运行测试脚本
./scripts/test/test-cookie-expiration.sh
```

测试脚本会自动模拟以下场景：

### 测试输出示例

```
========================================
Cookie 过期预警功能测试
========================================

📋 备份配置文件...
✓ 已备份到: config.yaml.backup-expiry-test

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
测试: 场景1: Cookie 正常（刚更新）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Cookie 更新时间: 2025-10-20 10:00:00
有效期: 7 天
预期结果: 🟢 正常

配置已更新，启动监控程序（3秒后自动停止）...

Cookie 状态: 🟢 正常 (剩余 7 天)

✓ 测试完成

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
测试: 场景2: Cookie 即将过期（提前48小时预警）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Cookie 更新时间: 2025-10-15 10:00:00
有效期: 7 天
预期结果: ⚠️ 即将过期

配置已更新，启动监控程序（3秒后自动停止）...

Cookie 状态: ⚠️ 即将过期 (剩余 48 小时)

✓ 测试完成

[更多测试场景...]

========================================
✅ 所有测试完成！
========================================
```

## 📊 定期检查机制

### 自动检查时间表

系统会在以下时机检查 Cookie 状态：

| 时机 | 频率 | 说明 |
|------|------|------|
| 程序启动 | 一次 | 立即检查并显示状态 |
| 定时任务 | 每日凌晨 1:00 | 自动执行检查 |
| 配置更新 | 配置变化时 | 热加载后重新评估 |

### 日志示例

```
# 启动时
2025/10/20 10:00:00 Cookie 状态: 🟢 正常 (剩余 7 天)

# 定时检查
2025/10/21 01:00:00 执行定期 Cookie 过期检查
2025/10/21 01:00:00 Cookie 状态: 🟢 正常 (剩余 6 天)

# 配置更新后
2025/10/21 10:30:00 配置文件已重新加载: config.yaml
2025/10/21 10:30:00 Cookie 状态: 🟢 正常 (剩余 7 天)
```

## 💡 使用技巧

### 技巧 1: 合理设置有效期

根据实际情况调整 `cookie_valid_days`：

```yaml
# 保守型（推荐新手）
cookie_valid_days: 7

# 标准型
cookie_valid_days: 14

# 延长型（已确认Cookie长期有效）
cookie_valid_days: 30
```

**建议**: 初期使用 7 天，观察实际过期时间后再调整。

### 技巧 2: 配合通知渠道

确保至少配置一种通知方式：

```yaml
# 方式 1: ServerChan
serverchan_sendkey: "SCT123456T"

# 方式 2: 微信群机器人
wechat_webhook_url: "https://qyapi.weixin.qq.com/..."

# 或者同时配置两种（双重保障）
```

### 技巧 3: 及时响应预警

- 收到预警后 24 小时内更新
- 设置手机日历提醒
- 在笔记中记录更新历史

### 技巧 4: 验证更新效果

更新后检查日志确认：

```bash
# 查看最近的日志
tail -f logs/monitor.log

# 查找 Cookie 相关日志
grep "Cookie 状态" logs/monitor.log
```

## 🎯 最佳实践

### 实践 1: 初次配置清单

- [ ] 设置 `lixiang_cookies`
- [ ] 设置 `cookie_updated_at` 为当前时间
- [ ] 设置 `cookie_valid_days` 为 7 天（初期）
- [ ] 配置通知渠道
- [ ] 启动程序验证状态
- [ ] 测试通知是否正常

### 实践 2: 定期维护清单

- [ ] 收到预警后及时更新
- [ ] 每次更新同时修改两个字段
- [ ] 记录每次更新时间
- [ ] 定期查看日志
- [ ] 根据实际情况调整有效期

### 实践 3: 故障预防

1. **双重保障**: 配置多个通知渠道
2. **提前更新**: 不要等到最后一刻
3. **定期检查**: 偶尔手动查看 Cookie 状态
4. **记录历史**: 记录每次更新的时间和原因

## 📈 效果对比

### 使用前

```
❌ Cookie 突然失效
❌ 监控中断
❌ 错过重要通知
❌ 需要频繁手动检查
```

### 使用后

```
✅ 提前 48 小时预警
✅ 从容更新 Cookie
✅ 监控持续运行
✅ 自动化检查无需人工干预
```

## 🔗 相关资源

- [Cookie 过期管理指南](../technical/COOKIE_EXPIRATION_WARNING.md)
- [Cookie 快速修复](./COOKIE_QUICK_FIX.md)
- [配置热加载演示](./HOT_RELOAD_DEMO.md)
- [测试指南](./TESTING_GUIDE.md)

## 🎬 总结

通过这个演示，你应该已经了解了：

1. ✅ 如何配置 Cookie 过期管理
2. ✅ Cookie 状态的含义
3. ✅ 如何响应过期预警
4. ✅ 如何更新 Cookie
5. ✅ 如何使用测试脚本验证功能

现在你可以放心使用 Cookie 过期预警功能，让它帮你自动监控 Cookie 状态，避免监控中断！

---

> 💡 **下一步**: 建议阅读 [Cookie 过期管理指南](../technical/COOKIE_EXPIRATION_WARNING.md) 了解更多技术细节和最佳实践。
