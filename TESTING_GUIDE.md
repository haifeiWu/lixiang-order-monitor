# 配置热加载功能 - 完整测试指南

## 测试环境准备

### 1. 编译项目
```bash
cd /Users/wuhaifei/Work/lixiang-order-monitor
go build -o lixiang-monitor main.go
```

### 2. 检查配置文件
确保 `config.yaml` 存在并配置正确：
```bash
cat config.yaml
```

## 完整测试流程

### 测试 1: 基本功能验证

#### 步骤 1: 启动服务
```bash
# 终端 1 - 启动监控服务并查看日志
./lixiang-monitor 2>&1 | tee monitor.log
```

预期输出：
```
2025/10/17 10:00:00 配置已加载，版本: 1
2025/10/17 10:00:00 ✅ 配置文件监听已启动
2025/10/17 10:00:00 ✅ 已配置 1 个通知器
2025/10/17 10:00:00 启动监控服务，检查间隔: @every 12h
```

✅ **验证点**: 
- 配置版本从 1 开始
- 配置文件监听已启动
- 服务正常启动

---

### 测试 2: 修改通知间隔

#### 步骤 1: 查看当前配置
```bash
# 终端 2
grep "notification_interval_hours" config.yaml
```

#### 步骤 2: 使用测试脚本修改
```bash
./test-hot-reload.sh
# 选择选项 1
# 输入新的小时数，例如: 48
```

#### 步骤 3: 观察日志输出（终端 1）
预期输出：
```
2025/10/17 10:01:00 检测到配置文件变化: config.yaml
2025/10/17 10:01:00 配置已加载，版本: 2
2025/10/17 10:01:00 ✅ 配置已成功热加载
2025/10/17 10:01:00 ServerChan 通知发送成功
```

✅ **验证点**:
- 检测到文件变化
- 配置版本递增到 2
- 热加载成功
- 发送配置更新通知

#### 步骤 4: 确认配置已更新
```bash
# 终端 2
grep "notification_interval_hours" config.yaml
```

✅ **验证点**: 配置值已更新为 48

---

### 测试 3: 切换定期通知开关

#### 步骤 1: 查看当前状态
```bash
grep "enable_periodic_notify" config.yaml
```

#### 步骤 2: 使用测试脚本切换
```bash
./test-hot-reload.sh
# 选择选项 2
```

#### 步骤 3: 观察日志（终端 1）
预期输出：
```
2025/10/17 10:02:00 检测到配置文件变化: config.yaml
2025/10/17 10:02:00 配置已加载，版本: 3
2025/10/17 10:02:00 ✅ 配置已成功热加载
```

✅ **验证点**:
- 配置版本递增到 3
- 开关状态已切换

---

### 测试 4: 手动修改配置

#### 步骤 1: 使用编辑器修改
```bash
# 终端 2
vim config.yaml

# 修改 order_id
# 修改 estimate_weeks_min 和 estimate_weeks_max
# 保存退出 (:wq)
```

#### 步骤 2: 观察自动重新加载（终端 1）
预期输出：
```
2025/10/17 10:03:00 检测到配置文件变化: config.yaml
2025/10/17 10:03:00 配置已加载，版本: 4
2025/10/17 10:03:00 ✅ 配置已成功热加载
```

✅ **验证点**: 
- 多个配置项同时修改成功
- 配置版本继续递增

---

### 测试 5: Cookie 更新场景

#### 步骤 1: 备份当前配置
```bash
cp config.yaml config.yaml.backup
```

#### 步骤 2: 更新 Cookie
```bash
# 使用 sed 修改 Cookie（macOS）
sed -i '' 's/lixiang_cookies: .*/lixiang_cookies: "NEW_COOKIE_STRING"/' config.yaml
```

#### 步骤 3: 验证热加载（终端 1）
预期输出：
```
2025/10/17 10:04:00 检测到配置文件变化: config.yaml
2025/10/17 10:04:00 配置已加载，版本: 5
2025/10/17 10:04:00 ✅ 配置已成功热加载
```

✅ **验证点**: Cookie 已更新，下次请求会使用新 Cookie

---

### 测试 6: 错误处理测试

#### 测试 6.1: YAML 格式错误

#### 步骤 1: 故意制造格式错误
```bash
# 备份
cp config.yaml config.yaml.good

# 破坏格式（缺少引号或缩进错误）
echo "invalid: yaml: content:" >> config.yaml
```

#### 步骤 2: 观察错误处理（终端 1）
预期输出：
```
2025/10/17 10:05:00 检测到配置文件变化: config.yaml
2025/10/17 10:05:00 重新读取配置文件失败: yaml: line XX: ...
```

✅ **验证点**:
- 检测到错误
- 继续使用旧配置运行
- 服务没有崩溃

#### 步骤 3: 恢复配置
```bash
cp config.yaml.good config.yaml
```

#### 测试 6.2: 检查间隔变更

#### 步骤 1: 修改检查间隔
```bash
sed -i '' 's/check_interval: .*/check_interval: "@every 6h"/' config.yaml
```

#### 步骤 2: 观察警告信息（终端 1）
预期输出：
```
2025/10/17 10:06:00 检测到配置文件变化: config.yaml
2025/10/17 10:06:00 重新加载配置失败: 检查间隔已变更，需要重启服务
2025/10/17 10:06:00 ⚠️  检测到检查间隔变更，请手动重启服务以应用新的检查间隔
```

✅ **验证点**: 
- 正确检测到检查间隔变更
- 提示用户需要重启
- 其他配置仍然有效

---

### 测试 7: 添加/移除通知器

#### 测试 7.1: 添加微信通知

#### 步骤 1: 修改配置
```bash
vim config.yaml
# 添加或取消注释 wechat_webhook_url
wechat_webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
```

#### 步骤 2: 观察日志（终端 1）
预期输出：
```
2025/10/17 10:07:00 检测到配置文件变化: config.yaml
2025/10/17 10:07:00 配置已加载，版本: 6
2025/10/17 10:07:00 ✅ 配置已成功热加载
```

#### 步骤 3: 查看配置更新通知
通知内容应该显示：
```
通知器数量: 2  （之前是 1）
```

✅ **验证点**: 通知器已动态添加

#### 测试 7.2: 移除通知器

#### 步骤 1: 清空通知器配置
```bash
sed -i '' 's/wechat_webhook_url: .*/wechat_webhook_url: ""/' config.yaml
```

#### 步骤 2: 验证（终端 1）
预期输出：
```
2025/10/17 10:08:00 检测到配置文件变化: config.yaml
2025/10/17 10:08:00 配置已加载，版本: 7
2025/10/17 10:08:00 ✅ 配置已成功热加载
```

✅ **验证点**: 通知器已移除

---

### 测试 8: 并发安全测试

#### 步骤 1: 在订单检查时修改配置

等待服务开始检查订单（根据 check_interval），然后立即修改配置：

```bash
# 监控日志，等待 "开始检查订单交付时间..." 出现
# 然后立即运行：
./test-hot-reload.sh
# 快速选择选项并修改
```

✅ **验证点**:
- 订单检查正常完成
- 配置更新成功
- 没有竞态条件错误
- 没有数据不一致

---

### 测试 9: 恢复备份配置

#### 步骤 1: 使用测试脚本恢复
```bash
./test-hot-reload.sh
# 选择选项 3（恢复备份配置）
```

#### 步骤 2: 观察日志（终端 1）
预期输出：
```
2025/10/17 10:09:00 检测到配置文件变化: config.yaml
2025/10/17 10:09:00 配置已加载，版本: 8
2025/10/17 10:09:00 ✅ 配置已成功热加载
```

✅ **验证点**: 
- 配置成功恢复到测试前状态
- 所有配置项回到初始值

---

### 测试 10: 配置版本跟踪

#### 步骤 1: 查看配置版本历史
```bash
grep "配置已加载，版本" monitor.log
```

预期输出：
```
2025/10/17 10:00:00 配置已加载，版本: 1
2025/10/17 10:01:00 配置已加载，版本: 2
2025/10/17 10:02:00 配置已加载，版本: 3
2025/10/17 10:03:00 配置已加载，版本: 4
...
```

✅ **验证点**: 
- 版本号连续递增
- 可以追踪配置变更历史

---

## 压力测试

### 测试 11: 快速连续修改

```bash
# 快速连续修改配置 10 次
for i in {1..10}; do
    sed -i '' "s/notification_interval_hours: .*/notification_interval_hours: $((24 + i))/" config.yaml
    sleep 1
done
```

✅ **验证点**:
- 所有修改都被正确检测
- 配置版本正确递增
- 没有丢失任何配置更新
- 系统保持稳定

---

## 性能测试

### 测试 12: 监控性能影响

#### 步骤 1: 检查内存使用
```bash
# 启动前
ps aux | grep lixiang-monitor

# 运行一段时间后
watch -n 5 'ps aux | grep lixiang-monitor'
```

#### 步骤 2: 频繁修改配置并观察
```bash
# 连续修改配置 50 次
for i in {1..50}; do
    ./test-hot-reload.sh << EOF
2
EOF
    sleep 2
done
```

✅ **验证点**:
- 内存使用保持稳定
- CPU 使用率正常
- 响应时间没有明显增加

---

## 完整测试检查清单

### 功能测试
- [ ] 服务启动时配置监听正常
- [ ] 修改配置后自动检测变化
- [ ] 配置成功重新加载
- [ ] 配置版本号正确递增
- [ ] 发送配置更新通知

### 配置项测试
- [ ] order_id 热加载成功
- [ ] lixiang_cookies 热加载成功
- [ ] 锁单时间配置热加载成功
- [ ] 通知器配置热加载成功
- [ ] 通知策略配置热加载成功
- [ ] check_interval 正确提示需要重启

### 错误处理测试
- [ ] YAML 格式错误正确处理
- [ ] 配置项验证失败正确处理
- [ ] 检查间隔变更提示正确

### 并发测试
- [ ] 配置修改时订单检查不受影响
- [ ] 没有竞态条件
- [ ] 数据一致性保持

### 性能测试
- [ ] 内存使用稳定
- [ ] CPU 使用正常
- [ ] 响应时间正常

---

## 测试结果记录

### 测试环境
- Go 版本: ___________
- 操作系统: ___________
- 测试时间: ___________

### 测试结果
| 测试编号 | 测试项目 | 结果 | 备注 |
|---------|---------|------|------|
| 1 | 基本功能验证 | ☐ 通过 ☐ 失败 | |
| 2 | 修改通知间隔 | ☐ 通过 ☐ 失败 | |
| 3 | 切换定期通知 | ☐ 通过 ☐ 失败 | |
| 4 | 手动修改配置 | ☐ 通过 ☐ 失败 | |
| 5 | Cookie 更新 | ☐ 通过 ☐ 失败 | |
| 6.1 | YAML 错误处理 | ☐ 通过 ☐ 失败 | |
| 6.2 | 检查间隔变更 | ☐ 通过 ☐ 失败 | |
| 7.1 | 添加通知器 | ☐ 通过 ☐ 失败 | |
| 7.2 | 移除通知器 | ☐ 通过 ☐ 失败 | |
| 8 | 并发安全 | ☐ 通过 ☐ 失败 | |
| 9 | 恢复备份 | ☐ 通过 ☐ 失败 | |
| 10 | 版本跟踪 | ☐ 通过 ☐ 失败 | |
| 11 | 快速连续修改 | ☐ 通过 ☐ 失败 | |
| 12 | 性能测试 | ☐ 通过 ☐ 失败 | |

### 问题记录
1. ___________________________________________
2. ___________________________________________
3. ___________________________________________

---

## 测试后清理

```bash
# 停止服务
pkill lixiang-monitor

# 恢复原始配置
cp config.yaml.backup config.yaml

# 清理测试备份
rm -f config.yaml.test-backup config.yaml.good config.yaml.backup-*

# 查看最终日志
tail -n 100 monitor.log
```

---

## 总结

通过以上完整的测试流程，可以全面验证配置热加载功能的：
- ✅ 功能完整性
- ✅ 稳定性
- ✅ 并发安全性
- ✅ 错误处理能力
- ✅ 性能表现

确保在生产环境使用前完成所有测试项目。
