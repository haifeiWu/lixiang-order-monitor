# 配置热加载功能演示

本文档展示配置热加载功能的实际使用场景。

## 快速开始

### 1. 启动监控服务

```bash
# 在终端1中启动服务
./lixiang-monitor

# 或者后台运行并查看日志
./lixiang-monitor > monitor.log 2>&1 &
tail -f monitor.log
```

你会看到类似的启动日志：
```
2025/10/17 10:00:00 配置已加载，版本: 1
2025/10/17 10:00:00 ✅ 配置文件监听已启动
2025/10/17 10:00:00 ✅ 已配置 1 个通知器
2025/10/17 10:00:00 启动监控服务，检查间隔: @every 12h
```

### 2. 测试配置热加载

在另一个终端中，使用测试脚本：

```bash
# 在终端2中运行测试脚本
./test-hot-reload.sh
```

或者手动修改配置文件：

```bash
# 编辑配置文件
vim config.yaml
```

### 3. 观察自动重新加载

修改配置并保存后，在终端1（监控服务的日志）中会看到：

```
2025/10/17 10:05:00 检测到配置文件变化: config.yaml
2025/10/17 10:05:00 配置已加载，版本: 2
2025/10/17 10:05:00 ✅ 配置已成功热加载
2025/10/17 10:05:00 ServerChan 通知发送成功
```

同时，如果配置了通知器，会收到配置更新通知。

## 典型使用场景

### 场景 1: Cookie 过期更新

**问题**: 理想汽车 Cookie 过期，API 请求失败

**日志表现**:
```
2025/10/17 10:00:00 获取订单数据失败: API 返回错误状态码: 401
```

**解决步骤**:

1. 从浏览器获取新的 Cookie
2. 打开配置文件：
   ```bash
   vim config.yaml
   ```

3. 更新 `lixiang_cookies` 字段：
   ```yaml
   lixiang_cookies: "新的Cookie字符串..."
   ```

4. 保存文件（`:wq`）

5. 观察日志，确认配置已重新加载：
   ```
   2025/10/17 10:05:00 检测到配置文件变化: config.yaml
   2025/10/17 10:05:00 ✅ 配置已成功热加载
   ```

6. 等待下次检查，确认请求成功：
   ```
   2025/10/17 10:30:00 当前预计交付时间: 2025-11-15
   ```

**优势**: 无需重启服务，立即生效，零停机时间。

---

### 场景 2: 添加微信通知

**需求**: 初始只配置了 ServerChan，现在想添加微信群机器人通知

**步骤**:

1. 获取微信群机器人 Webhook URL（参考 WECHAT_SETUP.md）

2. 编辑配置文件：
   ```yaml
   wechat_webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
   ```

3. 保存后观察日志：
   ```
   2025/10/17 10:10:00 检测到配置文件变化: config.yaml
   2025/10/17 10:10:00 配置已加载，版本: 3
   2025/10/17 10:10:00 ✅ 配置已成功热加载
   2025/10/17 10:10:00 ServerChan 通知发送成功
   2025/10/17 10:10:00 微信群机器人通知发送成功
   ```

4. 现在会同时收到两个渠道的通知

**结果**: 成功添加了新的通知渠道，后续所有通知都会发送到两个地方。

---

### 场景 3: 调整通知频率

**需求**: 觉得每 24 小时的定期通知太频繁，改为 48 小时

**步骤**:

1. 编辑配置文件：
   ```yaml
   notification_interval_hours: 48
   ```

2. 保存后查看日志：
   ```
   2025/10/17 10:15:00 检测到配置文件变化: config.yaml
   2025/10/17 10:15:00 配置已加载，版本: 4
   2025/10/17 10:15:00 ✅ 配置已成功热加载
   ```

3. 收到配置更新通知：
   ```
   ⚙️ 监控服务配置已更新
   
   配置版本: 4
   更新时间: 2025-10-17 10:15:00
   
   当前配置:
   订单ID: 177971759268550919
   检查间隔: @every 12h
   通知器数量: 2
   定期通知: true
   通知间隔: 48小时
   ```

**结果**: 定期通知间隔已调整，下次通知将在 48 小时后发送。

---

### 场景 4: 临时关闭定期通知

**需求**: 临时不想收到定期通知，但保留交付时间变化通知

**步骤**:

1. 使用测试脚本快速切换：
   ```bash
   ./test-hot-reload.sh
   # 选择选项 2（切换定期通知开关）
   ```

2. 或手动编辑配置：
   ```yaml
   enable_periodic_notify: false
   ```

3. 保存后确认：
   ```
   2025/10/17 10:20:00 检测到配置文件变化: config.yaml
   2025/10/17 10:20:00 配置已加载，版本: 5
   2025/10/17 10:20:00 ✅ 配置已成功热加载
   ```

**结果**: 
- ✅ 交付时间变化时仍会收到通知
- ✅ 临近交付时仍会收到提醒
- ❌ 不再收到定期状态报告

---

### 场景 5: 更新订单信息

**需求**: 购买了新车，需要监控新订单

**步骤**:

1. 编辑配置文件，更新订单相关信息：
   ```yaml
   order_id: "新的订单ID"
   lock_order_time: "2025-10-01 14:30:00"
   estimate_weeks_min: 9
   estimate_weeks_max: 11
   ```

2. 更新 Cookie（如果账号不同）：
   ```yaml
   lixiang_cookies: "新的Cookie..."
   ```

3. 保存后观察：
   ```
   2025/10/17 10:25:00 检测到配置文件变化: config.yaml
   2025/10/17 10:25:00 配置已加载，版本: 6
   2025/10/17 10:25:00 ✅ 配置已成功热加载
   ```

4. 下次检查时会使用新的订单信息：
   ```
   2025/10/17 10:30:00 开始检查订单交付时间...
   2025/10/17 10:30:00 当前预计交付时间: 2025-12-01
   2025/10/17 10:30:00 锁单时间: 2025-10-01 14:30:00
   ```

**结果**: 无缝切换到新订单的监控，无需重启服务。

---

## 配置变更监控

### 实时监控配置变化

使用此命令可以实时查看配置文件的变化：

```bash
# macOS
fswatch -o config.yaml | xargs -n1 -I{} echo "配置文件已修改"

# Linux (需要安装 inotify-tools)
while inotifywait -e modify config.yaml; do
    echo "配置文件已修改"
    grep -E "^(order_id|enable_periodic_notify|notification_interval_hours):" config.yaml
done
```

### 查看配置版本历史

通过日志可以追踪配置的变更历史：

```bash
# 查看所有配置加载记录
grep "配置已加载，版本" monitor.log

# 输出示例：
# 2025/10/17 10:00:00 配置已加载，版本: 1
# 2025/10/17 10:05:00 配置已加载，版本: 2
# 2025/10/17 10:10:00 配置已加载，版本: 3
```

---

## 注意事项

### ⚠️ 检查间隔不支持热加载

如果修改了 `check_interval`，会看到警告：

```
2025/10/17 10:30:00 检测到配置文件变化: config.yaml
2025/10/17 10:30:00 重新加载配置失败: 检查间隔已变更，需要重启服务
2025/10/17 10:30:00 ⚠️  检测到检查间隔变更，请手动重启服务以应用新的检查间隔
```

此时需要手动重启服务：

```bash
# 停止服务
pkill lixiang-monitor

# 或者使用 stop.sh
./stop.sh

# 重新启动
./start.sh
```

### 💡 配置备份建议

修改重要配置前，建议备份：

```bash
# 备份当前配置
cp config.yaml config.yaml.backup-$(date +%Y%m%d_%H%M%S)

# 如需恢复
cp config.yaml.backup-20251017_100000 config.yaml
```

### 🔍 验证配置格式

使用 YAML 验证工具检查格式（可选）：

```bash
# Python yaml 模块
python3 -c "import yaml; yaml.safe_load(open('config.yaml'))" && echo "✅ YAML 格式正确"

# 在线验证
# 访问 https://www.yamllint.com/
```

---

## 故障排查

### 问题 1: 配置修改后没有自动加载

**可能原因**:
- 文件保存失败
- YAML 格式错误
- 文件权限问题

**检查步骤**:

1. 确认文件已保存：
   ```bash
   ls -l config.yaml
   ```

2. 检查日志是否有错误：
   ```bash
   tail -n 50 monitor.log | grep -i error
   ```

3. 验证 YAML 格式：
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('config.yaml'))"
   ```

### 问题 2: 配置加载成功但没有收到通知

**可能原因**:
- 通知器配置错误
- 网络问题
- Webhook URL 或 SendKey 失效

**解决方法**:

1. 查看详细错误日志
2. 测试通知功能：
   ```bash
   ./test-notification.sh
   ```

### 问题 3: 配置频繁重新加载

**可能原因**:
- 编辑器自动保存
- 云同步软件
- 其他程序修改文件

**解决方法**:
- 关闭编辑器自动保存
- 排除云同步
- 使用 `vim` 或 `nano` 编辑

---

## 最佳实践

1. **渐进式修改**: 一次只修改一个配置项
2. **立即验证**: 修改后立即查看日志确认
3. **备份先行**: 重要修改前先备份
4. **测试优先**: 使用测试脚本验证功能
5. **日志监控**: 保持日志实时输出以便观察

---

## 总结

配置热加载功能大大提高了系统的灵活性和可维护性：

- ✅ **零停机更新**: 无需重启服务即可应用配置
- ✅ **即时生效**: 配置保存后立即加载
- ✅ **安全可靠**: 线程安全，不影响正在进行的检查
- ✅ **易于调试**: 详细的日志记录配置变化
- ✅ **通知确认**: 配置更新后自动发送通知

通过合理使用配置热加载功能，可以快速响应各种运维需求，提升监控系统的可用性。
